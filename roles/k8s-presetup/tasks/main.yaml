---
# roles/k8s-presetup/tasks/main.yml

- name: Disable swap
  become: true
  ansible.builtin.shell: |
    swapoff -a
    sed -i.bak '/swap/s/^/#/' /etc/fstab

- name: Disable firewall (ufw)
  become: true
  ansible.builtin.shell: |
    systemctl stop ufw || true
    systemctl disable ufw || true

- name: Disable selinux (for Debian/Ubuntu not used, but kept for portability)
  become: true
  ansible.builtin.shell: |
    if [ -f /etc/selinux/config ]; then
      setenforce 0 || true
      sed -i 's/^SELINUX=enforcing/SELINUX=permissive/' /etc/selinux/config
    fi

- name: Load br_netfilter kernel module
  become: true
  community.general.modprobe:
    name: br_netfilter
    state: present

- name: Ensure module loads on boot
  become: true
  ansible.builtin.copy:
    dest: /etc/modules-load.d/modules-kubernetes.conf
    content: |
      br_netfilter

- name: Configure kernel parameters
  become: true
  ansible.builtin.copy:
    dest: /etc/sysctl.d/99-kubernetes.conf
    content: |
      net.ipv4.ip_forward=1
      net.bridge.bridge-nf-call-iptables=1
      net.ipv4.ip_nonlocal_bind=1
      net.bridge.bridge-nf-call-ip6tables=1

- name: Apply sysctl
  become: true
  ansible.builtin.command: sysctl --system

# --- Kubernetes APT repo ---
- name: Disable CD-ROM repo if present
  become: true
  ansible.builtin.replace:
    path: /etc/apt/sources.list
    regexp: '^deb cdrom:.*$'
    replace: '# deb cdrom: disabled by ansible'

- name: Remove old kubernetes apt repo if exists
  become: true
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/kubernetes.list
    state: absent

- name: Create keyrings directory
  become: true
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'

- name: K8s repository for Ubuntu|Debian [Key]
  when: ansible_facts['os_family'] == "Debian"
  become: true
  ansible.builtin.get_url:
    url: "https://prod-cdn.packages.k8s.io/repositories/isv:/kubernetes:/core:/stable:/v{{ kube_version | regex_search('[0-9]+.[0-9]+') }}/deb/Release.key"
    dest: /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    mode: '0644'

- name: K8s repository for Ubuntu|Debian
  when: ansible_facts['os_family'] == "Debian"
  ansible.builtin.apt_repository:
    # repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v{{ kube_version | regex_search('[0-9]+.[0-9]+') }}/deb/ /"
    repo: "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://prod-cdn.packages.k8s.io/repositories/isv:/kubernetes:/core:/stable:/v{{ kube_version | regex_search('[0-9]+.[0-9]+') }}/deb/ /"
    state: present
    filename: kubernetes


- name: Update apt cache
  become: true
  ansible.builtin.apt:
    update_cache: yes

# --- Required packages ---
- name: Install required packages
  become: true
  ansible.builtin.apt:
    name:
      - bash-completion
      - python3
      - tar
      - containerd
      - nfs-common
      - chrony
      - kubectl
      - kubelet
      - kubeadm
    state: present

- name: Install optional packages
  become: true
  ansible.builtin.apt:
    name:
      - nano
      - git
      - jq
      - rsyslog
    state: present

# --- Services ---
- name: Enable and start chronyd
  become: true
  ansible.builtin.service:
    name: chrony
    state: started
    enabled: true

- name: Enable and start rsyslog (optional)
  become: true
  ansible.builtin.service:
    name: rsyslog
    state: started
    enabled: true

- name: Enable and start containerd
  become: true
  ansible.builtin.service:
    name: containerd
    state: started
    enabled: true

- name: Configure crictl
  become: true
  ansible.builtin.copy:
    dest: /etc/crictl.yaml
    content: |
      runtime-endpoint: "unix:///run/containerd/containerd.sock"
      image-endpoint: "unix:///run/containerd/containerd.sock"
      timeout: 0
      debug: false
      pull-image-on-create: false
      disable-pull-on-run: false
